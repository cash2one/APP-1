<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
    <title>个人中心</title>
    <link rel="stylesheet" type="text/css" href="css/mui.min.css"/>
    <link rel="stylesheet" type="text/css" href="css/m_common.css"/>
    <link rel="stylesheet" type="text/css" href="css/m_account_index.css"/>
</head>
	<body>
		<div class="mui-content">
			<div class="top">
        	<img id="userimg" src="images/user.png" alt="用户头像" />
				<a id="settings"><number id="mobile"></number><i class="icon iconfont">&#xe63d;</i></a>
			</div>

			<div class="mui-row">
		        <div class="mui-col-sm-4 mui-col-xs-4">
		            <li class="first mui-table-view-cell">
		                <a>
		                    	累计收益（个）<br /><br /><span><number id="accu_income"></number></span>
		                </a>
		            </li>
		        </div>
		        <div class="mui-col-sm-4 mui-col-xs-4">
		            <li class="mui-table-view-cell">
		                <a>
		                    	剩余福币（个）<br /><br /><span><number id="balance"></number></span>
		                </a>
		            </li>
		        </div>
		        <div class="mui-col-sm-4 mui-col-xs-4">
		            <li class="mui-table-view-cell">
		                <a>
		                    	剩余积分<br /><br /><span><number id="scores"></number></span>
		                </a>
		            </li>
		        </div>
    		</div>

			<ul class="mui-table-view">
			        <li class="mui-table-view-cell">
			            <a class="icon-qiandai mui-navigate-right" href="account/m_account_charge.html">
			                 福币管理
			            </a>
			        </li>
			        <li class="mui-table-view-cell">
			            <a class="icon-jifen mui-navigate-right"  href="account/m_account_score.html">
			                 	积分管理
			            </a>
			        </li>

			</ul>
			<ul class="mui-table-view">
			        <li class="mui-table-view-cell">
			            <a class="icon-iconfontfuli mui-navigate-right"  href="account/m_account_welfare.html">
			                 	福利管理
			            </a>
			        </li>
			       <li class="mui-table-view-cell">
			            <a class="icon-youhuiquan mui-navigate-right"  href="account/m_account_coupon.html">
			                 	优惠券管理
			            </a>
			        </li>
			</ul>
			<ul class="mui-table-view">
			        <li class="mui-table-view-cell">
			            <a class="icon-fuligonglve mui-navigate-right"  href="account/m_strategy.html">
			                 	挖福利攻略
			            </a>
			        </li>
              <li class="mui-table-view-cell">
                  <a class="icon-yaoqing mui-navigate-right"  href="account/m_account_invite.html">
                        邀请好友
                  </a>
              </li>
			</ul>

		</div>
	<script type="text/javascript" charset="UTF-8" src="js/mui.js"></script>
	<script type="text/javascript" charset="UTF-8" src="js/UserInfo.js"></script>
    <script type="text/javascript" charset="utf-8">
      	mui.init();
      	var get_userinfo_url = "http://test.wafuli.cn/app/user/";
      	var self = null;
      	var tempview = null;
      	mui.plusReady(function() {
      		self = plus.webview.currentWebview();
      		tempview = plus.webview.getWebviewById("temp");
      		self.addEventListener('show',function(){
      			if (!UserInfo.has_login()){
      				tologin();
      			}
      			else{
      				refresh_userinfo();
      			}
      		});
      		window.addEventListener('login-refresh',function(){
      			var info = UserInfo.userinfo();
      			display_userinfo(info);
      		});
      		window.addEventListener('logoff-refresh',function(){
      			display_userinfo();
      		});
      		function display_userinfo(dict){
      			if (!dict){
      				document.getElementById('userimg').src = "images/user.png";
					document.getElementById('mobile').innerText = "";
					document.getElementById('scores').innerText = "";
					document.getElementById('accu_income').innerHTML = "";
					document.getElementById('balance').innerText = "";
					document.getElementById('scores').innerText = "";
      			}
      			else{
      				var img = "images/user-0" + dict.userimg + ".png";
					document.getElementById('userimg').src = img;
					document.getElementById('mobile').innerText = dict.mobile;
					document.getElementById('scores').innerText = dict.scores;
					document.getElementById('accu_income').innerHTML = dict.accu_income;
					document.getElementById('balance').innerText = dict.balance
					document.getElementById('scores').innerText = dict.scores;
      			}
      		}
      		mui('.mui-table-view').on('tap', 'a', function(e) {
      			if (!UserInfo.has_login()){
      				tologin();
      			}
      			else{
      				var targetTab = this.getAttribute('href');
      				tempview.loadURL(targetTab);
      				setTimeout(function(){
      					tempview.show('pop-in');
      				},10);
//    				console.log(tempview.id);
//					mui.openWindow({
//			            url: targetTab,
//			            id: targetTab,
//			            styles: {
//			                top: 0,
//			                bottom: 0,
//			                hardwareAccelerated:true
//			            },
//			            show:{
//					      autoShow:false,//页面loaded事件发生后自动显示，默认为true
//					      aniShow: 'slide-in-right'
//					    },
//			            waiting: {
//							autoShow: true,
//						},
//			        });
      			}
			});
			document.getElementById("settings").addEventListener("tap",function(e) {
				if (!UserInfo.has_login()){
      				tologin();
      			}
      			else{
      				if (!tempview){
      					tempview = plus.webview.getWebviewById("temp");
      				}
      				tempview.loadURL("account/m_account_settings.html");
      				tempview.addEventListener('loaded',function(){
      					tempview.show('pop-in');
      				});
//					mui.openWindow({
//			            url: "account/m_account_settings.html",
//			            id: "account/m_account_settings.html",
//			            styles: {
//			                top: 0,
//			                bottom: 0,
//			                hardwareAccelerated:true
//			            },
//			            show:{
//					      autoShow:false,//页面loaded事件发生后自动显示，默认为true
//					      aniShow: 'slide-in-right'
//					    },
//			            waiting: {
//							autoShow: true,
//						},
//			        });
      			}
			});
			function tologin(){
				plus.nativeUI.showWaiting();
				localStorage.setItem('login-backid',self.id);
				if (!tempview){
  					return;
  				}
				tempview.loadURL("a_login.html");
				tempview.addEventListener('loaded',function(){
					plus.nativeUI.closeWaiting();
					tempview.show("pop-in",350);
				});
			}
			function refresh_userinfo(){
				mui.ajax({
					type: "post",
					url: get_userinfo_url,
					dataType: 'json',
					data:{
		    			token:UserInfo.token()
		    		},
					success: function(ret) {
						if(ret.code==0){
							var info = ret.info;
							display_userinfo(info);
							UserInfo.userinfo(info);
	    				}
	    				else if(ret.code<0){
	    					tologin();
	    					UserInfo.clear();
					        return;
	    				}
	    				else{
	    					mui.alert(ret.msg);
	    				}
					},
					error:function(xhr,type,errorThrown){
						mui.toast("请检查网络状况！");
					}
				});
			}
		});
    </script>
	</body>

</html>
